<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Khóa Học Mall Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --header-height: 60px; --sidebar-width: 350px; --primary-color: #0066cc; --active-bg: #e6f2ff; }
        
        /* BẢO MẬT: Chặn bôi đen toàn trang */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { height: var(--header-height); background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; position: relative; }
        .logo { font-size: 18px; font-weight: bold; color: #333; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--primary-color); font-size: 24px; }
        
        .header-actions { display: flex; gap: 10px; }

        .btn-unlock { background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%); color: #fff; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(255, 140, 0, 0.3); transition: transform 0.2s; }
        .btn-unlock:hover { transform: scale(1.05); }

        .btn-platform { color: #fff; padding: 8px 15px; border-radius: 20px; font-weight: bold; text-decoration: none; display: none; align-items: center; gap: 8px; font-size: 13px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-drive { background: #28a745; }
        .btn-drive:hover { background: #218838; }
        .btn-onedrive { background: #0078D4; }
        .btn-onedrive:hover { background: #005a9e; }

        /* Container */
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: var(--sidebar-width); border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; background: #fff; }
        .unit-group { border-bottom: 1px solid #eee; }
        .unit-header { padding: 15px 20px; background: #f8f9fa; cursor: pointer; font-weight: 600; color: #444; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .unit-header:hover { background: #e9ecef; }
        .unit-count { font-size: 12px; background: #ddd; padding: 2px 8px; border-radius: 10px; color: #555; }
        .lesson-list { list-style: none; display: none; }
        .unit-group.active .lesson-list { display: block; }

        .lesson-item { padding: 12px 20px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: center; gap: 10px; background: #fff; transition: 0.2s; font-size: 14px; }
        .lesson-item:hover { background: #f9f9f9; }
        .lesson-item.active { background: var(--active-bg); color: var(--primary-color); border-left: 3px solid var(--primary-color); font-weight: 500; }
        .lesson-item.locked { opacity: 0.8; color: #555; }
        .lesson-item.locked:hover { background: #fff8e1; }
        .lesson-item.unlocked { color: #2e7d32; font-weight: 500; }
        .folder-icon { color: #fbc02d; font-size: 16px; } 

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; background: #fff; display: flex; flex-direction: column; align-items: center; position: relative; overflow-y: auto; }
        .video-wrapper { width: 100%; max-width: 1000px; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; position: relative; margin-bottom: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        .video-overlay { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; display: none; }
        
        /* CHỈ DÙNG IFRAME ĐỂ ĐẢM BẢO ỔN ĐỊNH */
        iframe { width: 100%; height: 100%; border: none; display: none; }
        
        .placeholder { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; background: #222; text-align: center; }
        .info-area { width: 100%; max-width: 1000px; }
        .info-area h2 { font-size: 24px; margin-bottom: 10px; color: #333; }

        /* NOTES */
        .video-note { width: 100%; max-width: 1000px; background: #fff8e1; color: #795548; padding: 12px 15px; border-radius: 6px; font-size: 13px; line-height: 1.5; margin-bottom: 10px; border: 1px solid #ffe0b2; text-align: center; }
        .video-note i { color: #ff9800; margin-right: 5px; }
        .email-note { width: 100%; max-width: 1000px; background: #e3f2fd; color: #0d47a1; padding: 12px 15px; border-radius: 6px; font-size: 13px; line-height: 1.5; margin-bottom: 15px; border: 1px solid #bbdefb; text-align: center; }
        .email-note i { color: #2196f3; margin-right: 5px; }
        
        .drive-actions { width: 100%; max-width: 1000px; display: none; justify-content: flex-end; margin-bottom: 20px; }
        .btn-view-drive { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: #fff; border: 1px solid #ddd; border-radius: 6px; color: #555; font-size: 13px; text-decoration: none; transition: 0.2s; }
        .btn-view-drive:hover { background: #f5f5f5; color: #333; border-color: #ccc; }
        .btn-view-drive i { color: #28a745; }

        /* POPUP */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal { background: #fff; padding: 35px; border-radius: 16px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); animation: slideDown 0.3s; position: relative; }
        @keyframes slideDown { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .modal i.main-icon { font-size: 50px; color: #ff9800; margin-bottom: 15px; }
        .modal-actions { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .btn-buy { display: flex; justify-content: center; align-items: center; background: #0066cc; color: #fff; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; width: 100%; box-shadow: 0 4px 10px rgba(0, 102, 204, 0.3); transition: 0.2s; }
        .btn-buy:hover { background: #005bb5; }
        .btn-enter-pass { display: flex; justify-content: center; align-items: center; background: #fff; color: #0066cc; padding: 12px; border-radius: 8px; border: 1px solid #0066cc; font-weight: bold; width: 100%; cursor: pointer; transition: 0.2s; }
        .btn-enter-pass:hover { background: #e6f2ff; }
        .btn-close { position: absolute; top: 15px; right: 15px; color: #aaa; cursor: pointer; font-size: 24px; width: 30px; height: 30px; line-height: 30px; }
        .btn-close:hover { color: #555; }

        @media (max-width: 900px) {
            body { height: auto; overflow-y: auto; }
            header { padding: 0 10px; }
            .logo span { display: none; }
            .container { flex-direction: column; height: auto; overflow: visible; }
            .main-content { order: 1; padding: 10px; overflow: visible; display: block; }
            .sidebar { width: 100%; height: auto; max-height: none; order: 2; border-right: none; border-top: 5px solid #e6e6e6; overflow: visible; }
            .lesson-item { padding: 15px 10px; border-bottom: 1px solid #eee; }
            .btn-unlock span, .btn-platform span { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-graduation-cap"></i> <span id="headerTitle">Đang tải...</span></div>
        <div class="header-actions">
            <button class="btn-unlock" id="btnUnlock" onclick="showBuyModal()"><i class="fas fa-lock"></i> <span>Mở khóa nội dung</span></button>
            <a href="#" target="_blank" class="btn-platform btn-drive" id="btnDrive"><i class="fab fa-google-drive"></i> <span>GOOGLE DRIVE</span></a>
            <a href="#" target="_blank" class="btn-platform btn-onedrive" id="btnOneDrive"><i class="fas fa-cloud"></i> <span>ONEDRIVE</span></a>
        </div>
    </header>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div style="padding:20px; color:#888; text-align:center">Đang kết nối dữ liệu...</div>
        </div>
        <div class="main-content">
            <div class="video-wrapper">
                <iframe id="videoIframe" src="" allowfullscreen></iframe>
                <div class="video-overlay"></div>
                <div class="placeholder" id="placeholder"><i class="fas fa-play-circle" style="font-size: 50px; margin-bottom: 15px;"></i><p>Chọn video để bắt đầu</p></div>
            </div>
            
            <div class="video-note">
                <i class="fas fa-info-circle"></i>
                Drive chỉ để dùng lưu trữ video, nếu bị lỗi không phát được bạn hãy tải về để xem hoặc truy cập vào Link OneDrive nhé!<br>
                <b>Tất cả nội dung đều mở tải về 100%, cam kết không chặn tải.</b>
            </div>

            <div class="email-note">
                <i class="fas fa-envelope-open-text"></i>
                Khi đăng ký thành công - Link khóa/kèm "Pass" sẽ được gửi qua Email của bạn, để tìm khóa cứ vào Email sẽ thấy!<br>
                Truy cập <b>Email</b> tìm khóa ở <b>Hộp thư chính</b>.<br>
                Nếu không thấy, hãy kiểm tra mục <b>Quảng Cáo</b> và <b>Spam</b>.
            </div>

            <div class="drive-actions" id="driveActions">
                <a href="#" target="_blank" class="btn-view-drive" id="btnViewOnDrive"><i class="fab fa-google-drive"></i> Xem trên Drive</a>
            </div>

            <div class="info-area">
                <h2 id="lessonTitle">Chào mừng bạn</h2>
                <p id="lessonDesc" style="color:#666">Hãy chọn bài học từ danh sách bên trái.</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="buyModal">
        <div class="modal">
            <div class="btn-close" onclick="closeModal()">&times;</div>
            <i class="fas fa-folder-open main-icon"></i>
            <h3>Nội dung được bảo mật</h3>
            <p>Vui lòng đăng ký khóa học để truy cập tài liệu trên Google Drive và OneDrive.</p>
            <div class="modal-actions">
                <a href="https://khoahocmall.com/cua-hang/" target="_blank" class="btn-buy">ĐĂNG KÝ NGAY</a>
                <div class="btn-enter-pass" onclick="askPassword()">Nhập mật khẩu</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. TÍNH NĂNG BẢO MẬT ---
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; 
            if(e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.keyCode == 'P'.charCodeAt(0)) return false; 
        }
        document.ondragstart = function() { return false; };

        // --- CẤU HÌNH API ---
        const API_URL = "https://script.google.com/macros/s/AKfycbznSVj39gx0sP92P8FHKeesigC0iQiCQoa3_o1NMkG9QaBFxeSciVkY2_G29huiQjIh5A/exec"; 
        
        const urlParams = new URLSearchParams(window.location.search);
        const courseSlug = urlParams.get('course'); 
        let courseData = { trial: [], locked: [] };
        let isUnlocked = false;

        window.onload = function() {
            if (!courseSlug) { alert("Thiếu mã khóa học (Slug)!"); return; }
            const savedPass = localStorage.getItem('savedPass_' + courseSlug);
            if (savedPass) { loadData('unlock', savedPass, true); } else { loadData('getTrial'); }
        };

        async function loadData(action, password = '', isSilent = false) {
            try {
                let url = `${API_URL}?course=${courseSlug}&action=${action}`;
                if (password) url += `&pass=${password}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    if(!isSilent) alert(data.error); 
                    if(action === 'unlock') localStorage.removeItem('savedPass_' + courseSlug);
                    return;
                }

                if (action === 'unlock' || data.isFree) {
                    isUnlocked = true;
                    if (action === 'unlock') localStorage.setItem('savedPass_' + courseSlug, password);

                    document.getElementById('btnUnlock').style.display = 'none';
                    const btnDrive = document.getElementById('btnDrive');
                    btnDrive.style.display = 'flex';
                    btnDrive.href = data.driveLink;

                    const btnOneDrive = document.getElementById('btnOneDrive');
                    if(data.oneDriveLink && data.oneDriveLink.trim() !== "") {
                        btnOneDrive.style.display = 'flex';
                        btnOneDrive.href = data.oneDriveLink;
                    }

                    closeModal();

                    if (action === 'unlock') {
                         courseData.locked = sortVideosFirst(data.mainItems);
                         if(!isSilent) alert("Mở khóa thành công!");
                         if(courseData.trial.length === 0) loadData('getTrial', '', true);
                    } else {
                         if(data.name) document.getElementById('headerTitle').innerText = data.name;
                         courseData.trial = sortVideosFirst(data.trialItems);
                         courseData.locked = sortVideosFirst(data.lockedItems);
                         renderSidebar();
                    }
                    if(action === 'unlock') renderSidebar();

                } else {
                    if(data.name) document.getElementById('headerTitle').innerText = data.name;
                    courseData.trial = sortVideosFirst(data.trialItems);
                    if (!isUnlocked) {
                        courseData.locked = sortVideosFirst(data.lockedItems);
                    }
                    renderSidebar();
                }
            } catch (e) { console.error(e); }
        }

        function sortVideosFirst(items) {
            if(!items) return [];
            return items.sort((a, b) => {
                const aIsVideo = (a.type === 'video');
                const bIsVideo = (b.type === 'video');
                if (aIsVideo && !bIsVideo) return -1;
                if (!aIsVideo && bIsVideo) return 1;
                return a.name.localeCompare(b.name, 'vi', { numeric: true });
            });
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';
            createGroup(sidebar, "1. Học Thử (Miễn Phí)", courseData.trial, true, false);
            createGroup(sidebar, "2. Nội Dung Chính (Full)", courseData.locked, true, true);
        }

        function createGroup(container, title, items, isOpen, isMainContent) {
            const group = document.createElement('div');
            group.className = 'unit-group';
            if(isOpen) group.classList.add('active');

            const header = document.createElement('div');
            header.className = 'unit-header';
            header.innerHTML = `<span>${title}</span> <div><span class="unit-count">${items ? items.length : 0}</span> <i class="fas fa-chevron-down"></i></div>`;
            header.onclick = () => group.classList.toggle('active');

            const list = document.createElement('ul');
            list.className = 'lesson-list';

            if(!items || items.length === 0) {
                list.innerHTML = "<li style='padding:15px;color:#999;font-size:13px'>Chưa cập nhật...</li>";
            } else {
                items.forEach(item => {
                    const li = document.createElement('li');
                    
                    if (isMainContent && !isUnlocked) {
                        li.className = 'lesson-item locked';
                        const icon = item.type === 'folder' ? '<i class="fas fa-folder folder-icon"></i>' : '<i class="fas fa-file-video" style="color:#bbb"></i>';
                        li.innerHTML = `${icon} <span style="flex:1">${item.name}</span> <i class="fas fa-lock" style="color:#bbb; font-size:12px"></i>`;
                        li.onclick = () => showBuyModal();
                    } 
                    else if (isMainContent && isUnlocked) {
                        li.className = 'lesson-item unlocked';
                        const icon = item.type === 'folder' ? '<i class="fas fa-folder-open folder-icon" style="color:#2e7d32"></i>' : '<i class="fas fa-file-video" style="color:#2e7d32"></i>';
                        li.innerHTML = `${icon} <span style="flex:1">${item.name}</span> <i class="fas fa-check-circle" style="color:#2e7d32; font-size:12px"></i>`;
                        li.onclick = () => {
                             if(item.type === 'folder') { window.open(item.link || item.driveLink, '_blank'); }
                             else { 
                                 // SỬA LỖI PHÁT: Luôn dùng Preview Link (Iframe)
                                 const previewLink = convertToPreviewLink(item.link); 
                                 const viewLink = item.driveLink || item.link;
                                 playVideo(previewLink, viewLink, item.name, li);
                             }
                        };
                    } 
                    else {
                        li.className = 'lesson-item';
                        li.innerHTML = `<i class="far fa-play-circle" style="color:#0066cc"></i> <span style="flex:1">${item.name}</span>`;
                        li.onclick = () => {
                            const previewLink = convertToPreviewLink(item.link);
                            const viewLink = item.driveLink || item.link;
                            playVideo(previewLink, viewLink, item.name, li);
                        };
                    }
                    list.appendChild(li);
                });
            }
            group.appendChild(header);
            group.appendChild(list);
            container.appendChild(group);
        }

        // HÀM XỬ LÝ LINK CHUẨN (IFRAME PREVIEW)
        function convertToPreviewLink(link) { 
            try { 
                // 1. Google Drive -> Convert về Preview
                if(link.includes("drive.google.com")) {
                    // Nếu là link download -> chuyển về preview
                    if(link.includes("export=download")) {
                        return link.replace("export=download", "").replace("&id=", "/file/d/") + "/preview";
                    }
                    // Nếu là link view -> chuyển về preview
                    const idMatch = link.match(/id=([^&]+)/) || link.match(/\/d\/([^\/]+)/);
                    if (idMatch) return `https://drive.google.com/file/d/${idMatch[1]}/preview`;
                }
                
                // 2. Facebook
                if(link.includes("facebook.com") && !link.includes("plugins/video.php")) {
                    return `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(link)}&show_text=0&width=560`;
                }

                // 3. YouTube
                if((link.includes("youtube.com") || link.includes("youtu.be")) && !link.includes("embed")) {
                    let videoId = "";
                    if(link.includes("v=")) videoId = link.split("v=")[1].split("&")[0];
                    else if(link.includes("youtu.be/")) videoId = link.split("youtu.be/")[1];
                    if(videoId) return `https://www.youtube.com/embed/${videoId}`;
                }

                return link; 
            } catch (e) { return link; } 
        }

        function playVideo(link, viewLink, title, element) {
            const iframe = document.getElementById('videoIframe');
            const placeholder = document.getElementById('placeholder');
            const driveActions = document.getElementById('driveActions');
            const btnViewOnDrive = document.getElementById('btnViewOnDrive');
            
            placeholder.style.display = 'none';
            iframe.style.display = 'block';
            iframe.src = link;

            // Hiện nút View on Drive nếu là link Drive
            if(link.includes("drive.google.com")) {
                driveActions.style.display = 'flex';
                btnViewOnDrive.href = viewLink;
            } else {
                driveActions.style.display = 'none';
            }

            document.getElementById('lessonTitle').innerText = title;
            document.getElementById('lessonDesc').innerText = "Đang phát video...";
            document.querySelectorAll('.lesson-item').forEach(e => e.classList.remove('active'));
            element.classList.add('active');
        }

        function showBuyModal() { document.getElementById('buyModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('buyModal').style.display = 'none'; }
        function askPassword() {
            closeModal();
            setTimeout(() => { const pass = prompt("Nhập mật khẩu truy cập:"); if(pass) loadData('unlock', pass); }, 100);
        }
    </script>
</body>
</html>
