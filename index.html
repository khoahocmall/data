<script>
        // --- BẢO MẬT ---
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; 
            if(e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.keyCode == 'P'.charCodeAt(0)) return false; 
        }
        document.ondragstart = function() { return false; };

        // --- CẤU HÌNH API ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzwMvTRcnPW-Q9xQCso8nxkdy_KoprQzwBjen6O3rP7FjA5JsWDFqkZOMOvacCLWFMCbw/exec"; 
        
        const urlParams = new URLSearchParams(window.location.search);
        const courseSlug = urlParams.get('course'); 
        
        let courseData = { trial: [], locked: [] };
        let isUnlocked = false;

        window.onload = function() {
            if (!courseSlug) { alert("Thiếu mã khóa học (Slug)!"); return; }
            const savedPass = localStorage.getItem('savedPass_' + courseSlug);
            
            // Ưu tiên loadData preview trước để check xem có Free không
            // Nếu có savedPass thì gửi kèm luôn để unlock
            if (savedPass) { 
                loadData('unlock', savedPass, true); 
            } else { 
                loadData('getTrial'); 
            }
        };

        async function loadData(action, password = '', isSilent = false) {
            try {
                let url = `${API_URL}?course=${courseSlug}&action=${action}`;
                if (password) url += `&pass=${password}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    if(!isSilent) alert(data.error); 
                    if(action === 'unlock') localStorage.removeItem('savedPass_' + courseSlug);
                    return;
                }

                // --- XỬ LÝ MỞ KHÓA (HOẶC TỰ ĐỘNG FREE) ---
                if (action === 'unlock' || data.isFree) {
                    isUnlocked = true;

                    // 1. Cập nhật giao diện Header
                    document.getElementById('btnUnlock').style.display = 'none';
                    
                    const btnDrive = document.getElementById('btnDrive');
                    btnDrive.style.display = 'flex';
                    btnDrive.href = data.driveLink;

                    const btnOneDrive = document.getElementById('btnOneDrive');
                    if(data.oneDriveLink && data.oneDriveLink.trim() !== "") {
                        btnOneDrive.style.display = 'flex';
                        btnOneDrive.href = data.oneDriveLink;
                    }

                    // 2. Cập nhật dữ liệu bài học
                    if (action === 'unlock') {
                         // Nếu gọi unlock -> lấy từ mainItems
                         localStorage.setItem('savedPass_' + courseSlug, password);
                         courseData.locked = sortByName(data.mainItems);
                         closeModal();
                         if(!isSilent) alert("Mở khóa thành công!");
                         
                         // Nếu trial chưa có thì load thêm trial
                         if(courseData.trial.length === 0) loadData('getTrial', '', true);

                    } else {
                         // Nếu là data.isFree (getTrial trả về) -> lấy từ lockedItems (lúc này đã có link)
                         if(data.name) document.getElementById('headerTitle').innerText = data.name;
                         courseData.trial = sortByName(data.trialItems);
                         courseData.locked = sortByName(data.lockedItems);
                         renderSidebar();
                    }
                    
                    // Render lại nếu đang ở luồng unlock
                    if(action === 'unlock') renderSidebar();

                } else {
                    // --- CHẾ ĐỘ DÙNG THỬ (CÓ PASS) ---
                    if(data.name) document.getElementById('headerTitle').innerText = data.name;
                    courseData.trial = sortByName(data.trialItems);
                    
                    // Chỉ cập nhật list locked nếu chưa mở khóa
                    if (!isUnlocked) {
                        courseData.locked = sortByName(data.lockedItems);
                    }
                    renderSidebar();
                }
            } catch (e) { console.error(e); }
        }

        function sortByName(items) {
            if(!items) return [];
            return items.sort((a, b) => a.name.localeCompare(b.name));
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';
            createGroup(sidebar, "1. Học Thử (Miễn Phí)", courseData.trial, true, false);
            createGroup(sidebar, "2. Nội Dung Chính (Full)", courseData.locked, true, true);
        }

        function createGroup(container, title, items, isOpen, isMainContent) {
            const group = document.createElement('div');
            group.className = 'unit-group';
            if(isOpen) group.classList.add('active');

            const header = document.createElement('div');
            header.className = 'unit-header';
            header.innerHTML = `<span>${title}</span> <div><span class="unit-count">${items.length}</span> <i class="fas fa-chevron-down"></i></div>`;
            header.onclick = () => group.classList.toggle('active');

            const list = document.createElement('ul');
            list.className = 'lesson-list';

            if(items.length === 0) {
                list.innerHTML = "<li style='padding:15px;color:#999;font-size:13px'>Chưa cập nhật...</li>";
            } else {
                items.forEach(item => {
                    const li = document.createElement('li');
                    
                    // LOGIC HIỂN THỊ
                    if (isMainContent && !isUnlocked) {
                        // CHƯA MỞ KHÓA -> ICON KHÓA
                        li.className = 'lesson-item locked';
                        const icon = item.type === 'folder' ? '<i class="fas fa-folder folder-icon"></i>' : '<i class="fas fa-file-video" style="color:#bbb"></i>';
                        li.innerHTML = `${icon} <span style="flex:1">${item.name}</span> <i class="fas fa-lock" style="color:#bbb; font-size:12px"></i>`;
                        li.onclick = () => showBuyModal();
                    } 
                    else if (isMainContent && isUnlocked) {
                        // ĐÃ MỞ KHÓA (HOẶC FREE) -> ICON XANH
                        li.className = 'lesson-item unlocked';
                        const icon = item.type === 'folder' ? '<i class="fas fa-folder-open folder-icon" style="color:#2e7d32"></i>' : '<i class="fas fa-file-video" style="color:#2e7d32"></i>';
                        li.innerHTML = `${icon} <span style="flex:1">${item.name}</span> <i class="fas fa-check-circle" style="color:#2e7d32; font-size:12px"></i>`;
                        
                        li.onclick = () => {
                             if(item.type === 'folder') {
                                 window.open(item.link || item.driveLink, '_blank');
                             } else {
                                 const previewLink = convertToPreviewLink(item.link);
                                 const viewLink = item.driveLink;
                                 playVideo(previewLink, viewLink, item.name, li);
                             }
                        };
                    } 
                    else {
                        // HỌC THỬ
                        li.className = 'lesson-item';
                        li.innerHTML = `<i class="far fa-play-circle" style="color:#0066cc"></i> <span style="flex:1">${item.name}</span>`;
                        li.onclick = () => {
                            const previewLink = convertToPreviewLink(item.link);
                            const viewLink = convertToViewLink(item.link);
                            playVideo(previewLink, viewLink, item.name, li);
                        };
                    }
                    
                    list.appendChild(li);
                });
            }
            group.appendChild(header);
            group.appendChild(list);
            container.appendChild(group);
        }

        // CÁC HÀM HỖ TRỢ GIỮ NGUYÊN
        function convertToPreviewLink(link) { try { const idMatch = link.match(/id=([^&]+)/); if (idMatch) return `https://drive.google.com/file/d/${idMatch[1]}/preview`; return link; } catch (e) { return link; } }
        function convertToViewLink(link) { try { const idMatch = link.match(/id=([^&]+)/); if (idMatch) return `https://drive.google.com/file/d/${idMatch[1]}/view`; return link; } catch (e) { return link; } }

        function playVideo(previewLink, viewLink, title, element) {
            const iframe = document.getElementById('videoPlayer');
            const placeholder = document.getElementById('placeholder');
            const driveActions = document.getElementById('driveActions');
            const btnViewOnDrive = document.getElementById('btnViewOnDrive');
            
            placeholder.style.display = 'none';
            iframe.style.display = 'block';
            iframe.src = previewLink;
            driveActions.style.display = 'flex';
            btnViewOnDrive.href = viewLink;

            document.getElementById('lessonTitle').innerText = title;
            document.getElementById('lessonDesc').innerText = "Đang phát video...";
            document.querySelectorAll('.lesson-item').forEach(e => e.classList.remove('active'));
            element.classList.add('active');
        }

        function showBuyModal() { document.getElementById('buyModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('buyModal').style.display = 'none'; }
        function askPassword() {
            closeModal();
            setTimeout(() => { const pass = prompt("Nhập mật khẩu truy cập:"); if(pass) loadData('unlock', pass); }, 100);
        }
    </script>
