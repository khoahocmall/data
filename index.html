<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khóa Học Mall Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --header-height: 60px; --sidebar-width: 350px; --primary-color: #0066cc; --active-bg: #e6f2ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { height: var(--header-height); background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; }
        .logo { font-size: 18px; font-weight: bold; color: #333; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--primary-color); font-size: 24px; }
        
        .btn-unlock { background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%); color: #fff; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(255, 140, 0, 0.3); transition: transform 0.2s; }
        .btn-unlock:hover { transform: scale(1.05); }

        /* Sidebar & Container */
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: var(--sidebar-width); border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; background: #fff; }
        .unit-group { border-bottom: 1px solid #eee; }
        .unit-header { padding: 15px 20px; background: #f8f9fa; cursor: pointer; font-weight: 600; color: #444; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .unit-header:hover { background: #e9ecef; }
        .unit-count { font-size: 12px; background: #ddd; padding: 2px 8px; border-radius: 10px; color: #555; }
        .lesson-list { list-style: none; display: none; }
        .unit-group.active .lesson-list { display: block; }

        .lesson-item { padding: 12px 20px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: center; gap: 10px; background: #fff; transition: 0.2s; font-size: 14px; }
        .lesson-item:hover { background: #f9f9f9; }
        .lesson-item.active { background: var(--active-bg); color: var(--primary-color); border-left: 3px solid var(--primary-color); font-weight: 500; }
        
        /* Trạng thái khóa/mở khóa */
        .lesson-item.locked { opacity: 0.8; color: #555; }
        .lesson-item.locked:hover { background: #fff8e1; }
        .lesson-item.unlocked { color: #2e7d32; font-weight: 500; }
        .folder-icon { color: #fbc02d; font-size: 16px; } 

        /* Main Content */
        .main-content { flex: 1; padding: 30px; background: #fff; display: flex; flex-direction: column; align-items: center; position: relative; }
        .video-wrapper { width: 100%; max-width: 1000px; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; position: relative; margin-bottom: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        iframe { width: 100%; height: 100%; border: none; }
        .placeholder { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; background: #222; text-align: center; }
        .info-area { width: 100%; max-width: 1000px; }
        .info-area h2 { font-size: 24px; margin-bottom: 10px; color: #333; }
        .drive-actions { width: 100%; max-width: 1000px; display: none; justify-content: flex-end; margin-bottom: 20px; }
        .btn-view-drive { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: #fff; border: 1px solid #ddd; border-radius: 6px; color: #555; font-size: 13px; text-decoration: none; transition: 0.2s; }
        .btn-view-drive:hover { background: #f5f5f5; color: #333; border-color: #ccc; }
        .btn-view-drive i { color: #28a745; }

        /* --- POPUP MUA HÀNG ĐẸP HƠN --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal { background: #fff; padding: 35px; border-radius: 16px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); animation: slideDown 0.3s; position: relative; }
        @keyframes slideDown { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal i.main-icon { font-size: 50px; color: #ff9800; margin-bottom: 15px; }
        .modal h3 { margin-bottom: 10px; color: #333; font-size: 20px; }
        .modal p { color: #666; margin-bottom: 25px; font-size: 14px; line-height: 1.5; }
        
        /* Cân chỉnh 2 nút bằng nhau */
        .modal-actions { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        
        .btn-buy { 
            display: flex; justify-content: center; align-items: center; 
            background: #0066cc; color: #fff; padding: 12px; border-radius: 8px; 
            text-decoration: none; font-weight: bold; width: 100%; box-shadow: 0 4px 10px rgba(0, 102, 204, 0.3);
            transition: 0.2s;
        }
        .btn-buy:hover { background: #005bb5; }
        
        .btn-enter-pass {
            display: flex; justify-content: center; align-items: center;
            background: #fff; color: #0066cc; padding: 12px; border-radius: 8px;
            border: 1px solid #0066cc; font-weight: bold; width: 100%; cursor: pointer;
            transition: 0.2s;
        }
        .btn-enter-pass:hover { background: #e6f2ff; }

        .btn-close { position: absolute; top: 15px; right: 15px; color: #aaa; cursor: pointer; font-size: 24px; width: 30px; height: 30px; line-height: 30px; }
        .btn-close:hover { color: #555; }

        @media (max-width: 900px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 400px; order: 2; border-right: none; border-top: 1px solid #ddd; }
            .main-content { order: 1; padding: 15px; }
            .btn-unlock span { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-graduation-cap"></i> <span id="headerTitle">Đang tải...</span></div>
        <button class="btn-unlock" id="btnUnlock" onclick="showBuyModal()"><i class="fas fa-lock"></i> <span>Mở khóa nội dung</span></button>
    </header>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div style="padding:20px; color:#888; text-align:center">Đang kết nối dữ liệu...</div>
        </div>
        <div class="main-content">
            <div class="video-wrapper">
                <iframe id="videoPlayer" src="" allowfullscreen style="display:none"></iframe>
                <div class="placeholder" id="placeholder"><i class="fas fa-play-circle" style="font-size: 50px; margin-bottom: 15px;"></i><p>Chọn video <b>Học Thử</b> để bắt đầu</p></div>
            </div>
            
            <div class="drive-actions" id="driveActions">
                <a href="#" target="_blank" class="btn-view-drive" id="btnViewOnDrive"><i class="fab fa-google-drive"></i> Xem trên Drive</a>
            </div>

            <div class="info-area">
                <h2 id="lessonTitle">Chào mừng bạn</h2>
                <p id="lessonDesc" style="color:#666">Hãy chọn video từ danh sách bên trái để trải nghiệm.</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="buyModal">
        <div class="modal">
            <div class="btn-close" onclick="closeModal()">&times;</div>
            <i class="fas fa-folder-open main-icon"></i>
            <h3>Nội dung được bảo mật</h3>
            <p>Vui lòng đăng ký khóa học để truy cập các chương chuyên sâu và tài liệu gốc.</p>
            
            <div class="modal-actions">
                <a href="https://khoahocmall.com/cua-hang/" target="_blank" class="btn-buy">
                    ĐĂNG KÝ NGAY
                </a>
                <div class="btn-enter-pass" onclick="askPassword()">
                    Nhập mật khẩu
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- BẢO MẬT ---
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if(e.keyCode == 123 || (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S'))) { e.preventDefault(); return false; }
        });

        // --- CẤU HÌNH API ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzSvqjQffrSe8bOWkU9b7Ivb7odrp9lwWT_pjKn1gCLB2Av_DsAEpnSrIIZCrw5LsxEdQ/exec"; 
        
        const urlParams = new URLSearchParams(window.location.search);
        const courseSlug = urlParams.get('course'); 
        
        let courseData = { trial: [], locked: [] };
        let isUnlocked = false; // Biến trạng thái

        window.onload = function() {
            if (!courseSlug) { alert("Thiếu mã khóa học (Slug)!"); return; }
            const savedPass = localStorage.getItem('savedPass_' + courseSlug);
            if (savedPass) { loadData('unlock', savedPass, true); } else { loadData('getTrial'); }
        };

        async function loadData(action, password = '', isSilent = false) {
            try {
                let url = `${API_URL}?course=${courseSlug}&action=${action}`;
                if (password) url += `&pass=${password}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    if(!isSilent) alert(data.error); 
                    if(action === 'unlock') localStorage.removeItem('savedPass_' + courseSlug);
                    return;
                }

                if (action === 'unlock') {
                    // MỞ KHÓA THÀNH CÔNG
                    localStorage.setItem('savedPass_' + courseSlug, password);
                    document.getElementById('btnUnlock').style.display = 'none';
                    
                    // Cập nhật dữ liệu Nội Dung Chính với Link thật
                    courseData.locked = sortByName(data.mainItems);
                    isUnlocked = true; // Đánh dấu đã mở khóa
                    
                    renderSidebar(); // Vẽ lại sidebar để cập nhật icon và link
                    
                    closeModal();
                    if(!isSilent) alert("Mở khóa thành công!");

                } else {
                    // LOAD DATA BAN ĐẦU
                    if(data.name) document.getElementById('headerTitle').innerText = data.name;
                    courseData.trial = sortByName(data.trialItems);
                    courseData.locked = sortByName(data.lockedItems);
                    renderSidebar();
                }
            } catch (e) { console.error(e); }
        }

        function sortByName(items) {
            if(!items) return [];
            return items.sort((a, b) => a.name.localeCompare(b.name));
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';
            // Render Nhóm 1: Học Thử
            createGroup(sidebar, "1. Học Thử (Miễn Phí)", courseData.trial, true, false);
            // Render Nhóm 2: Nội Dung Chính (Có truyền trạng thái isUnlocked)
            createGroup(sidebar, "2. Nội Dung Chính (Full)", courseData.locked, true, true);
        }

        function createGroup(container, title, items, isOpen, isMainContent) {
            const group = document.createElement('div');
            group.className = 'unit-group';
            if(isOpen) group.classList.add('active');

            const header = document.createElement('div');
            header.className = 'unit-header';
            header.innerHTML = `<span>${title}</span> <div><span class="unit-count">${items.length}</span> <i class="fas fa-chevron-down"></i></div>`;
            header.onclick = () => group.classList.toggle('active');

            const list = document.createElement('ul');
            list.className = 'lesson-list';

            if(items.length === 0) {
                list.innerHTML = "<li style='padding:15px;color:#999;font-size:13px'>Chưa cập nhật...</li>";
            } else {
                items.forEach(item => {
                    const li = document.createElement('li');
                    
                    // Xử lý giao diện Locked vs Unlocked
                    if (isMainContent && !isUnlocked) {
                        // CHƯA MỞ KHÓA
                        li.className = 'lesson-item locked';
                        const icon = item.type === 'folder' ? '<i class="fas fa-folder folder-icon"></i>' : '<i class="fas fa-file-video" style="color:#bbb"></i>';
                        li.innerHTML = `${icon} <span style="flex:1">${item.name}</span> <i class="fas fa-lock" style="color:#bbb; font-size:12px"></i>`;
                        li.onclick = () => showBuyModal();
                    } 
                    else if (isMainContent && isUnlocked) {
                        // ĐÃ MỞ KHÓA
                        li.className = 'lesson-item unlocked';
                        // Icon folder mở hoặc file video xanh
                        const icon = item.type === 'folder' ? '<i class="fas fa-folder-open folder-icon" style="color:#2e7d32"></i>' : '<i class="fas fa-file-video" style="color:#2e7d32"></i>';
                        li.innerHTML = `${icon} <span style="flex:1">${item.name}</span> <i class="fas fa-check-circle" style="color:#2e7d32; font-size:12px"></i>`;
                        
                        // Click -> Mở tab mới tới Drive
                        li.onclick = () => {
                             window.open(item.link || item.driveLink, '_blank');
                        };
                    } 
                    else {
                        // HỌC THỬ
                        li.className = 'lesson-item';
                        li.innerHTML = `<i class="far fa-play-circle" style="color:#0066cc"></i> <span style="flex:1">${item.name}</span>`;
                        li.onclick = () => {
                            const previewLink = convertToPreviewLink(item.link);
                            const viewLink = convertToViewLink(item.link);
                            playVideo(previewLink, viewLink, item.name, li);
                        };
                    }
                    
                    list.appendChild(li);
                });
            }
            group.appendChild(header);
            group.appendChild(list);
            container.appendChild(group);
        }

        function convertToPreviewLink(link) { try { const idMatch = link.match(/id=([^&]+)/); if (idMatch) return `https://drive.google.com/file/d/${idMatch[1]}/preview`; return link; } catch (e) { return link; } }
        function convertToViewLink(link) { try { const idMatch = link.match(/id=([^&]+)/); if (idMatch) return `https://drive.google.com/file/d/${idMatch[1]}/view`; return link; } catch (e) { return link; } }

        function playVideo(previewLink, viewLink, title, element) {
            const iframe = document.getElementById('videoPlayer');
            const placeholder = document.getElementById('placeholder');
            const driveActions = document.getElementById('driveActions');
            const btnViewOnDrive = document.getElementById('btnViewOnDrive');
            
            placeholder.style.display = 'none';
            iframe.style.display = 'block';
            iframe.src = previewLink;
            driveActions.style.display = 'flex';
            btnViewOnDrive.href = viewLink;

            document.getElementById('lessonTitle').innerText = title;
            document.getElementById('lessonDesc').innerText = "Đang phát video...";
            document.querySelectorAll('.lesson-item').forEach(e => e.classList.remove('active'));
            element.classList.add('active');
        }

        function showBuyModal() { document.getElementById('buyModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('buyModal').style.display = 'none'; }
        function askPassword() {
            closeModal();
            setTimeout(() => { const pass = prompt("Nhập mật khẩu truy cập:"); if(pass) loadData('unlock', pass); }, 100);
        }
    </script>
</body>
</html>
