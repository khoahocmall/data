<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khóa Học Mall Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --header-height: 60px;
            --sidebar-width: 350px;
            --primary-color: #0066cc; 
            --active-bg: #e6f2ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; /* Chặn bôi đen */ }
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header {
            height: var(--header-height); background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100;
        }
        .logo { font-size: 18px; font-weight: bold; color: #333; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--primary-color); font-size: 24px; }
        
        .btn-unlock {
            background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%); color: #fff; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(255, 140, 0, 0.3); transition: transform 0.2s;
        }
        .btn-unlock:hover { transform: scale(1.05); }

        .container { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR (DANH SÁCH BÀI HỌC) */
        .sidebar { width: var(--sidebar-width); border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; background: #fff; }
        
        /* Accordion Style */
        .unit-group { border-bottom: 1px solid #eee; }
        .unit-header {
            padding: 15px 20px; background: #f8f9fa; cursor: pointer; font-weight: 600; color: #444; display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .unit-header:hover { background: #e9ecef; }
        .unit-header i { transition: transform 0.3s; }
        .unit-group.active .unit-header i { transform: rotate(180deg); }
        .unit-count { font-size: 12px; background: #ddd; padding: 2px 8px; border-radius: 10px; color: #555; }

        .lesson-list { list-style: none; display: none; /* Mặc định ẩn */ }
        .unit-group.active .lesson-list { display: block; /* Hiện khi active */ }

        .lesson-item {
            padding: 12px 20px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: center; gap: 10px; background: #fff; transition: 0.2s; font-size: 14px;
        }
        .lesson-item:hover { background: #f9f9f9; }
        .lesson-item.active { background: var(--active-bg); color: var(--primary-color); border-left: 3px solid var(--primary-color); font-weight: 500; }
        
        /* Style cho bài bị khóa */
        .lesson-item.locked { opacity: 0.7; color: #666; }
        .lesson-item.locked:hover { background: #fff3cd; } /* Màu vàng nhạt cảnh báo */

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; background: #fff; display: flex; flex-direction: column; align-items: center; position: relative; }
        
        .video-wrapper {
            width: 100%; max-width: 1000px; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; position: relative; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        video { width: 100%; height: 100%; outline: none; }
        
        .placeholder {
            position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; background: #222; text-align: center;
        }

        .info-area { width: 100%; max-width: 1000px; }
        .info-area h2 { font-size: 24px; margin-bottom: 10px; color: #333; }

        /* POPUP MODAL (Thông báo mua hàng) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideDown 0.3s;
        }
        @keyframes slideDown { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal i { font-size: 50px; color: #ff9800; margin-bottom: 15px; }
        .modal h3 { margin-bottom: 10px; color: #333; }
        .modal p { color: #666; margin-bottom: 20px; font-size: 14px; line-height: 1.5; }
        .btn-buy {
            display: inline-block; background: #0066cc; color: #fff; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; width: 100%; margin-bottom: 10px;
        }
        .btn-close { color: #999; cursor: pointer; font-size: 13px; text-decoration: underline; }

        /* Responsive */
        @media (max-width: 900px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 400px; order: 2; border-right: none; border-top: 1px solid #ddd; }
            .main-content { order: 1; padding: 15px; }
            .btn-unlock span { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <i class="fas fa-graduation-cap"></i> <span id="headerTitle">Đang tải khóa học...</span>
        </div>
        <button class="btn-unlock" onclick="askPassword()">
            <i class="fas fa-key"></i> <span>Mở khóa toàn bộ</span>
        </button>
    </header>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div style="padding:20px; color:#888; text-align:center">Đang kết nối dữ liệu...</div>
        </div>

        <div class="main-content">
            <div class="video-wrapper">
                <video id="videoPlayer" controls controlsList="nodownload" style="display:none"></video>
                <div class="placeholder" id="placeholder">
                    <i class="fas fa-play-circle" style="font-size: 50px; margin-bottom: 15px;"></i>
                    <p>Chọn bài học để bắt đầu</p>
                </div>
            </div>

            <div class="info-area">
                <h2 id="lessonTitle">Chào mừng bạn</h2>
                <p style="color:#666">Hãy chọn video từ danh sách <b>Học Thử</b> để trải nghiệm.</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="buyModal">
        <div class="modal">
            <i class="fas fa-lock"></i>
            <h3>Nội dung này bị khóa</h3>
            <p>Để xem trọn bộ nội dung và tài liệu nâng cao, bạn vui lòng đăng ký khóa học chính thức.</p>
            <a href="https://khoahocmall.com/cua-hang/" target="_blank" class="btn-buy">ĐĂNG KÝ NGAY</a>
            <div class="btn-close" onclick="closeModal()">Đóng cửa sổ này</div>
        </div>
    </div>

    <script>
        // --- 1. BẢO MẬT: CHẶN CHUỘT PHẢI, F12, COPY ---
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if(e.keyCode == 123 || (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S'))) {
                e.preventDefault(); return false;
            }
        });
        
        // --- 2. LOGIC ỨNG DỤNG ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzFM8R_4F5iVPoJag_B04z5UMD82ksqVSSlSErIXkK5f2B3zFm1I5PPJd2q_8ULWbquRQ/exec"; 
        const urlParams = new URLSearchParams(window.location.search);
        const courseSlug = urlParams.get('course'); 

        let courseData = { trial: [], locked: [] };

        window.onload = function() {
            if (!courseSlug) { alert("Thiếu mã khóa học (Slug)!"); return; }
            loadData('getTrial');
        };

        async function loadData(action, password = '') {
            try {
                let url = `${API_URL}?course=${courseSlug}&action=${action}`;
                if (password) url += `&pass=${password}`;

                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    alert(data.error); return;
                }

                if (action === 'unlock') {
                    // MỞ KHÓA THÀNH CÔNG -> REDIRECT
                    if(data.driveLink) {
                        alert("Mật khẩu chính xác! Đang chuyển hướng đến thư mục Drive...");
                        window.location.href = data.driveLink;
                    }
                } else {
                    // LOAD LIST BÀI HỌC
                    if(data.name) document.getElementById('headerTitle').innerText = data.name;
                    courseData.trial = data.trialItems;
                    courseData.locked = data.lockedItems;
                    renderSidebar();
                }

            } catch (e) { alert("Lỗi kết nối máy chủ."); }
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';

            // Render Nhóm 1: Học Thử (Mở mặc định)
            createGroup(sidebar, "1. Học Thử (Miễn Phí)", courseData.trial, true, false);

            // Render Nhóm 2: Nội Dung Chính (Mặc định đóng hoặc mở tùy ý)
            createGroup(sidebar, "2. Nội Dung Chính (VIP)", courseData.locked, true, true);
        }

        function createGroup(container, title, items, isOpen, isLockedGroup) {
            const group = document.createElement('div');
            group.className = 'unit-group';
            if(isOpen) group.classList.add('active');

            // Header Nhóm (Accordion)
            const header = document.createElement('div');
            header.className = 'unit-header';
            header.innerHTML = `<span>${title}</span> <div><span class="unit-count">${items.length}</span> <i class="fas fa-chevron-down"></i></div>`;
            header.onclick = () => group.classList.toggle('active');

            // Danh sách bài
            const list = document.createElement('ul');
            list.className = 'lesson-list';

            if(items.length === 0) {
                list.innerHTML = "<li style='padding:15px;color:#999;font-size:13px'>Chưa cập nhật...</li>";
            } else {
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = `lesson-item ${isLockedGroup ? 'locked' : ''}`;
                    
                    const icon = isLockedGroup ? '<i class="fas fa-lock" style="color:#ff9800"></i>' : '<i class="far fa-play-circle" style="color:#0066cc"></i>';
                    
                    li.innerHTML = `${icon} <span style="flex:1">${item.name}</span>`;
                    
                    li.onclick = () => {
                        if(isLockedGroup) {
                            // Nếu bấm vào bài khóa -> Hiện Modal mua hàng
                            showBuyModal();
                        } else {
                            // Nếu bấm bài học thử -> Phát video
                            playVideo(item.link, item.name, li);
                        }
                    };
                    list.appendChild(li);
                });
            }

            group.appendChild(header);
            group.appendChild(list);
            container.appendChild(group);
        }

        function playVideo(link, title, element) {
            const player = document.getElementById('videoPlayer');
            const placeholder = document.getElementById('placeholder');
            
            placeholder.style.display = 'none';
            player.style.display = 'block';
            player.src = link;
            player.play();

            document.getElementById('lessonTitle').innerText = title;
            
            // Highlight bài đang xem
            document.querySelectorAll('.lesson-item').forEach(e => e.classList.remove('active'));
            element.classList.add('active');
        }

        function showBuyModal() {
            document.getElementById('buyModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('buyModal').style.display = 'none';
        }

        function askPassword() {
            const pass = prompt("Nhập mật khẩu để truy cập Kho Tài Liệu Gốc trên Drive:");
            if(pass) loadData('unlock', pass);
        }
    </script>
</body>
</html>
